<html>
    <head><meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <title>Mtg Deck Builder</title>
        <!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"> -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
        <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/css/select2.min.css" rel="stylesheet" />
    </head>
    <body>
        <div class="container">
            <div class="row">
                <div class="input-group mb-3">
                    <select class="form-control search_card"></select>
                </div>
                <button id="add_card">Add</button>
            </div>
        </div>

        <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
        <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script> -->
        <!-- <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script> -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/js/select2.min.js"></script>

        <script>

            var deck = {};

            var selected_cards = {};

            $('.search_card').select2({
                ajax: {
                    delay: 1000,
                    url: 'https://api.scryfall.com/cards/search',
                    dataType: 'json',
                    data: function (params) {
                        var queryParameters = {
                            q: params.term
                        }
                        return queryParameters;
                    },
                    processResults: function (data) {
                        debugger;
                        // {
                        //     "results": [
                        //         {
                        //             "text": "Mountain Time Zone",
                        //             "children": [
                        //                 {
                        //                     "id": "CA",
                        //                     "text": "California"
                        //                 },
                        //                 {
                        //                     "id": "CO",
                        //                     "text": "Colarado"
                        //                 }
                        //             ]
                        //         }
                        //     ]
                        // }

                        var types = data.data.map(function(card){return card.type_line;});
                        var results = types.map(function(card_type){
                            return {
                                "text": card_type,
                                "children": data.data
                                            .filter(function(card){
                                                    return card_type == card.type_line
                                                })
                                            .map(function(card) {
                                                    return {
                                                        id: card.name,
                                                        text: card.name,
                                                        card: card
                                                    };
                                                })
                            }
                        });

                        return {
                            // results: data.data
                            results: results
                        };
                    }
                },
                placeholder: 'Search for a card',
                templateResult: function(value) {
                    return value.name;
                },
                templateSelection: function(value) {
                    selected_cards[value.id] = value;
                    return value.name;
                }
            });

            $('#add_card').on('click', function(e){
                debugger;

                // get selected card
                var id = $('.search_card').val();
                var card = selected_cards[id];
                // if card is already in deck, increase
                if (deck[card.name]) {
                    deck[card.name].number++;
                    return;
                }
                if (card) {
                    deck[card.name] = {
                        number: 1,
                        card: card,
                        tags: []
                    };
                }
                // delete old cards...
                selected_cards = {};
                selected_cards[id] = card;
            });


        </script>

    </body>
</html>
